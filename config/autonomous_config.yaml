# Autonomous System Configuration
# El sistema actúa automáticamente según estos parámetros
# Solo alerta al usuario si es CRÍTICO

version: "1.5"
last_updated: "2026-02-02T21:30:00"

# =============================================================================
# PROJECT ROADMAP - Fases del proyecto con dependencias
# =============================================================================
roadmap:
  current_phase: 1

  phases:
    # -------------------------------------------------------------------------
    # FASE 1: Setup inicial y primeros agentes
    # -------------------------------------------------------------------------
    phase_1:
      name: "Setup Inicial"
      status: in_progress  # pending, in_progress, completed, blocked
      started: "2026-02-01"
      estimated_duration_weeks: 2

      objectives:
        - "NautilusTrader instalado y funcionando"
        - "SB3 + Gymnasium configurado"
        - "RunPod configurado para GPU"
        - "Primeros 8-16 agentes entrenados"

      deliverables:
        - "gym_env/nautilus_env.py funcionando"
        - "training/train_agent.py funcionando"
        - "Modelos guardados en models/"

      exit_criteria:
        min_agents_trained: 8
        training_pipeline_working: true
        validation_pipeline_working: true

      current_work:
        pod_id: "3lobfx9w41qjzs"
        agents_training: ["agent_008", "agent_009", "agent_010", "agent_011",
                         "agent_012", "agent_013", "agent_014", "agent_015"]
        estimated_completion: "2026-02-02 23:00 UTC"

    # -------------------------------------------------------------------------
    # FASE 2: Integración SB3 → Nautilus Live
    # -------------------------------------------------------------------------
    phase_2:
      name: "Integración SB3 → Nautilus"
      status: completed  # 2026-02-03 - 3/3 tareas completadas
      depends_on: [phase_1]
      started: "2026-02-02"
      completed: "2026-02-03"
      estimated_duration_weeks: 2-3

      objectives:
        - "Cargar modelo SB3 entrenado en estrategia Nautilus"
        - "Backtest con costes reales (comisiones, slippage)"
        - "Comparar métricas Gym vs Nautilus backtest"

      deliverables:
        - "strategies/rl_strategy.py con carga de modelo"
        - "scripts/backtest_with_costs.py"
        - "Reporte comparativo Gym vs Nautilus"

      tasks:
        - id: "2.1"
          name: "Crear RLTradingStrategy"
          description: "Strategy class que carga modelo .zip y ejecuta predict()"
          owner: "@quant_developer"
          status: completed  # 2026-02-02
          files: ["strategies/rl_strategy.py"]

        - id: "2.2"
          name: "Backtest con costes"
          description: "Ejecutar backtest incluyendo comisiones IBKR/Binance y slippage"
          owner: "@quant_developer"
          status: completed  # 2026-02-02, D-021
          files: ["scripts/backtest_with_costs.py"]

        - id: "2.3"
          name: "Comparativa métricas"
          description: "Comparar Sharpe/DD/WR entre Gym training y Nautilus backtest"
          owner: "@rl_engineer"
          status: completed  # 2026-02-03, issues resolved by D-019
          files: ["validation/compare_gym_nautilus.py"]
          resolution: "D-019 Linux-Native Catalog fixed training pipeline"

      exit_criteria:
        strategy_loads_model: true
        backtest_runs_with_costs: true
        metrics_comparison_documented: true

      risk_check:
        # Si métricas Nautilus son >30% peores que Gym, hay problema
        max_performance_degradation_pct: 30
        action_if_exceeded: "investigate_before_proceeding"
        status: "RESOLVED - D-019 fixed catalog issues"

    # -------------------------------------------------------------------------
    # FASE 3: Baseline con Estrategias de Reglas
    # -------------------------------------------------------------------------
    phase_3:
      name: "Baseline Estrategias Reglas"
      status: completed  # Completado 2026-02-02
      depends_on: [phase_2]
      started: "2026-02-02"
      completed: "2026-02-02"
      estimated_duration_weeks: 2-3

      objectives:
        - "Implementar EMA Cross simple en Nautilus"
        - "Implementar RSI Mean Reversion"
        - "Backtest con mismos datos que RL"
        - "Establecer benchmark para comparar con RL"

      deliverables:
        - "strategies/ema_cross_strategy.py"
        - "strategies/rsi_mean_reversion.py"
        - "Reporte benchmark vs RL agents"

      tasks:
        - id: "3.1"
          name: "EMA Cross Strategy"
          description: "Estrategia simple: comprar cuando EMA rápida cruza EMA lenta"
          owner: "@quant_developer"
          status: completed  # 2026-02-02
          params:
            ema_fast: 12
            ema_slow: 26
          files: ["strategies/ema_cross_strategy.py"]

        - id: "3.2"
          name: "RSI Mean Reversion"
          description: "Comprar RSI<30, vender RSI>70"
          owner: "@quant_developer"
          status: completed  # 2026-02-02
          params:
            rsi_period: 14
            oversold: 30
            overbought: 70
          files: ["strategies/rsi_mean_reversion.py"]

        - id: "3.3"
          name: "Benchmark Report"
          description: "Comparar RL agents vs estrategias de reglas"
          owner: "@rl_engineer"
          status: completed  # 2026-02-02
          files: ["validation/benchmark_rl_vs_rules.py"]

      exit_criteria:
        baseline_strategies_working: true  # PASSED
        benchmark_documented: true  # PASSED - benchmark_results/
        rl_outperforms_baseline: pending  # Requiere agentes RunPod

      results:
        benchmark_date: "2026-02-02"
        buy_hold_sharpe: 0.87
        ema_cross_sharpe: 0.35
        rsi_meanrev_sharpe: -0.17
        best_test_rl_sharpe: 0.71  # agent_val_001
        note: "Test agents only - awaiting RunPod trained agents"

      risk_check:
        # Si RL NO supera baseline, revisar reward function
        action_if_rl_loses: "review_reward_function_and_features"

    # -------------------------------------------------------------------------
    # FASE 4: ML Supervisado (Feature Validation)
    # -------------------------------------------------------------------------
    phase_4:
      name: "ML Supervisado para Features"
      status: completed_with_warning  # D-024: Features ~50% accuracy
      depends_on: [phase_2]
      started: "2026-02-02"
      completed: "2026-02-02"
      estimated_duration_weeks: 3-4
      optional: true  # Útil pero no bloqueante

      objectives:
        - "Entrenar XGBoost/LightGBM para predecir dirección"
        - "Usar mismas features que RL (45 features)"
        - "Obtener feature importance"
        - "Opcionalmente usar predicción como input adicional a RL"

      deliverables:
        - "ml_supervised/feature_validator.py"  # DONE
        - "Reporte de feature importance"  # DONE
        - "Opcional: RL agent con ML predictions como feature"

      tasks:
        - id: "4.1"
          name: "Dataset para ML"
          description: "Crear dataset X (features) e y (dirección siguiente barra)"
          owner: "@rl_engineer"
          status: completed  # Integrado en feature_validator.py
          files: ["ml_supervised/feature_validator.py"]

        - id: "4.2"
          name: "Entrenar XGBoost"
          description: "Clasificador binario: sube/baja"
          owner: "@rl_engineer"
          status: completed
          params:
            algorithm: "xgboost"
            target: "next_bar_direction"
            cv_folds: 5
          files: ["ml_supervised/feature_validator.py"]

        - id: "4.3"
          name: "Feature Importance"
          description: "Analizar qué features son más predictivas"
          owner: "@rl_engineer"
          status: completed
          files: ["ml_supervised/feature_validator.py"]

      results:
        validation_date: "2026-02-02"
        symbols_tested: ["SPY", "AAPL", "MSFT", "BTCUSDT", "ETHUSDT"]
        avg_accuracy: 48.9  # ~random
        best_accuracy: 52.6  # AAPL
        worst_accuracy: 44.6  # BTCUSDT
        top_features: ["rsi_normalized", "ma20_diff", "bb_position"]
        warning: "Features ~50% accuracy - not predictive for direction"
        decision: "Continue with RL (can learn non-linear patterns)"
        reference: "D-024 in DECISIONS.md"

      exit_criteria:
        xgboost_trained: true
        feature_importance_documented: true
        accuracy_above_random: true  # >52% accuracy

      insights_for_rl:
        # Lo que aprendamos aquí mejora el RL
        - "Features con alta importancia → aumentar peso en observation"
        - "Features con baja importancia → considerar eliminar"
        - "Si accuracy ~50% → features no son predictivas, problema de datos"

    # -------------------------------------------------------------------------
    # FASE 5: Escalar RL a 500 Agentes
    # -------------------------------------------------------------------------
    phase_5:
      name: "Escalar a 500 Agentes"
      status: pending
      depends_on: [phase_3]  # Solo escalar si RL > baseline
      estimated_duration_weeks: 4-6

      objectives:
        - "Entrenar 500 agentes con diferentes seeds/configs"
        - "Hyperparameter search"
        - "Walk-forward validation"
        - "Ensemble de mejores agentes"

      deliverables:
        - "500 modelos entrenados"
        - "~50 agentes validados (filtros 1-4)"
        - "Ensemble configurado"

      infrastructure:
        # Usa la config de training.runpod ya definida
        use_runpod: true
        batches: 63  # 500 / 8 agentes por batch
        estimated_hours: 44
        estimated_cost_usd: 88

      tasks:
        - id: "5.1"
          name: "Hyperparameter configs"
          description: "Crear 500 configuraciones variando lr, gamma, net_arch, etc."
          owner: "@rl_engineer"
          status: completed  # 2026-02-03
          files: ["configs/agents_500_pro.yaml", "configs/agents_generated/"]

        - id: "5.2"
          name: "Batch training"
          description: "Ejecutar training en RunPod"
          owner: "@mlops_engineer"
          status: in_progress  # batch_2 (6 crypto) running
          files: ["training/runpod_launcher.py", "scripts/launch_batch_training.py"]

        - id: "5.3"
          name: "Validación 5 filtros"
          description: "Ejecutar pipeline de validación"
          owner: "@rl_engineer"
          status: ready  # scripts prepared
          files: ["validation/run_validation.py", "scripts/validate_batch.py"]

        - id: "5.4"
          name: "Configurar ensemble"
          description: "Seleccionar mejores agentes para voting"
          owner: "@rl_engineer"
          status: ready  # voting_system.py exists
          files: ["live/voting_system.py"]

      exit_criteria:
        agents_trained: 500
        agents_validated: 50  # ~10% pasan todos los filtros
        ensemble_configured: true

    # -------------------------------------------------------------------------
    # FASE 6: Paper Trading
    # -------------------------------------------------------------------------
    phase_6:
      name: "Paper Trading"
      status: pending
      depends_on: [phase_5]
      estimated_duration_weeks: 4

      objectives:
        - "Conectar ensemble a IBKR paper account"
        - "Monitoreo 24/7"
        - "Comparar resultados reales vs backtest"
        - "Ajustar risk management"

      deliverables:
        - "4 semanas de paper trading"
        - "Reporte comparativo paper vs backtest"
        - "Risk parameters ajustados"

      tasks:
        - id: "6.1"
          name: "Conectar IBKR Paper"
          description: "Configurar TradingNode con IBKR paper account"
          owner: "@quant_developer"
          files: ["live/ibkr_paper_config.py"]

        - id: "6.2"
          name: "Monitoreo 24/7"
          description: "Configurar alertas y dashboards"
          owner: "@mlops_engineer"
          files: ["monitoring/"]

        - id: "6.3"
          name: "Análisis semanal"
          description: "Revisar performance cada semana"
          owner: "@rl_engineer"
          frequency: "weekly"

        - id: "6.4"
          name: "Ajustar risk"
          description: "Modificar position sizing basado en resultados reales"
          owner: "@quant_developer"
          files: ["config/autonomous_config.yaml"]

      exit_criteria:
        paper_days_completed: 28
        paper_sharpe_min: 1.0
        paper_max_drawdown_pct: 10.0
        paper_vs_backtest_degradation_max_pct: 20

      go_live_criteria:
        # Criterios para pasar a live
        min_paper_sharpe: 1.0
        max_paper_drawdown: 10.0
        min_paper_days: 28
        user_approval_required: true  # Única fase que requiere aprobación

    # -------------------------------------------------------------------------
    # FASE 7: Live Trading
    # -------------------------------------------------------------------------
    phase_7:
      name: "Live Trading"
      status: pending
      depends_on: [phase_6]
      estimated_duration_weeks: ongoing

      objectives:
        - "Capital inicial pequeño"
        - "Risk management estricto"
        - "Escalar si funciona"

      initial_capital:
        usd: 10000  # Empezar pequeño
        max_position_pct: 5  # 5% por posición

      scaling_rules:
        # Escalar capital si performance es buena
        after_weeks: 4
        if_sharpe_above: 1.5
        if_drawdown_below_pct: 10
        scale_factor: 2.0  # Duplicar capital
        max_capital_usd: 100000

      tasks:
        - id: "7.1"
          name: "Conectar IBKR Live"
          description: "Cambiar de paper a live account"
          owner: "@quant_developer"
          user_approval_required: true

        - id: "7.2"
          name: "Monitoreo continuo"
          description: "Dashboards, alertas, circuit breakers activos"
          owner: "@mlops_engineer"

        - id: "7.3"
          name: "Revisión mensual"
          description: "Evaluar performance y decidir scaling"
          owner: "@team_review"
          frequency: "monthly"

      circuit_breakers_active: true  # Usa la config de circuit_breakers

  # ---------------------------------------------------------------------------
  # Reglas de transición entre fases
  # ---------------------------------------------------------------------------
  transition_rules:
    auto_advance: false  # Requiere revisión manual para avanzar de fase

    on_phase_complete:
      - "Actualizar current_phase"
      - "Documentar en DECISIONS.md"
      - "Notificar por Telegram"

    on_exit_criteria_failed:
      - "Investigar causa"
      - "Documentar en LESSONS_LEARNED.md"
      - "Decidir: retry o skip (si opcional)"

# =============================================================================
# DQ-001: VALIDATION THRESHOLDS
# Agentes que no pasen estos filtros son descartados automáticamente
# Ajustados según docs/reference/entrenamiento_profesional_rl_trading.md (D-020)
# =============================================================================
validation:
  filter_1_basic:
    min_sharpe_ratio: 1.2      # Ajustado: doc dice >1.0 aceptable, >1.5 bueno
    max_drawdown_pct: 15.0     # Mantiene: doc dice <15% bueno
    min_win_rate_pct: 45.0     # Ajustado: doc dice >45% aceptable
    min_profit_factor: 1.2     # Mantiene: doc dice >1.2 aceptable
    min_trades: 50  # Mínimo de trades para ser estadísticamente relevante

  filter_2_cross_validation:
    min_out_of_sample_sharpe: 1.0  # Puede ser menor que in-sample
    max_performance_degradation_pct: 30.0  # vs in-sample

  filter_3_diversity:
    max_correlation: 0.5  # Entre agentes seleccionados
    min_unique_signals_pct: 20.0  # % de señales que difieren del grupo

  filter_4_walkforward:
    window_train_months: 12
    window_test_months: 3
    min_windows_passed: 3  # De 4 ventanas posibles

  filter_5_paper:
    min_paper_days: 14
    max_paper_drawdown_pct: 10.0
    min_paper_sharpe: 1.0

  # Auto-acción: agentes que no pasen son archivados, no eliminados
  auto_action: archive_failed

# =============================================================================
# DQ-002: POSITION SIZING & RISK
# =============================================================================
position_sizing:
  method: confidence_scaled  # fixed, linear, kelly, confidence_scaled

  base_position_usd: 1000  # Posición base por señal
  max_position_per_symbol_usd: 5000
  max_total_exposure_usd: 50000

  # Scaling por confianza del voting
  confidence_scaling:
    min_confidence: 0.6  # Debajo de esto, no opera
    low_confidence: 0.7   # 50% del base
    medium_confidence: 0.8  # 100% del base
    high_confidence: 0.9   # 150% del base

# =============================================================================
# DQ-003: TRAINING INFRASTRUCTURE
# =============================================================================
training:
  # Modo híbrido: desarrollo local, producción en RunPod
  default_mode: local  # local, runpod, hybrid

  local:
    max_parallel_agents: 2
    use_gpu: true
    timesteps_per_agent: 1_000_000  # Reducido para local

  runpod:
    instance_type: "NVIDIA A100 80GB"
    max_parallel_agents: 8
    timesteps_per_agent: 5_000_000
    auto_shutdown_after_hours: 2
    max_cost_per_run_usd: 50

  # Auto-switch a RunPod si:
  auto_runpod_trigger:
    agents_count_threshold: 10  # Más de 10 agentes → RunPod
    total_timesteps_threshold: 10_000_000

  # Hyperparameter search (D-020)
  hyperparameter_search:
    enabled: true
    method: optuna
    n_trials: 50
    params_to_search:
      learning_rate: [1e-5, 1e-3]
      batch_size: [64, 256, 512]
      n_steps: [1024, 2048, 4096]
      gamma: [0.99, 0.999]

# =============================================================================
# DATA REQUIREMENTS (D-020 - según docs/reference/)
# =============================================================================
data_requirements:
  min_years_history: 3          # Mínimo para walk-forward validation
  recommended_years: 5          # Recomendado por documentación profesional
  optimal_years: 10             # Óptimo para resultados robustos
  min_bars_per_instrument: 750  # ~3 años de datos diarios

  # Estado actual vs requerido
  current_status:
    years_available: 1          # Solo 2024 actualmente
    gap: critical               # Necesita más datos
    action: "Obtener datos históricos 2019-2023"

# =============================================================================
# ML SUPERVISADO - FASE 4 (D-020 - según SPEC_ML_Nautilus.md)
# =============================================================================
ml_supervised:
  enabled: true
  algorithm: xgboost

  # Criterios de aceptación
  min_accuracy_above_random: 52   # >50% significa que hay señal
  target_accuracy: 55             # Objetivo realista
  warning_if_above: 65            # Si >65%, verificar data leakage

  # Configuración de entrenamiento
  horizon_days: 1                 # Predecir próximo día
  train_test_split: 0.7           # 70% train, 30% test (temporal)

  # Integración con RL
  integrate_with_rl:
    min_accuracy: 54              # Solo integrar si accuracy > 54%
    method: hybrid                # ML predice, RL decide
    add_as_feature: true          # Añadir prob_up como feature al RL

  # Archivos (según SPEC)
  files:
    features: "ml/features.py"
    trainer: "ml/train.py"
    ml_strategy: "strategies/ml_strategy.py"
    hybrid_strategy: "strategies/hybrid_strategy.py"

# =============================================================================
# CIRCUIT BREAKERS - Acciones automáticas
# =============================================================================
circuit_breakers:
  # Nivel 1: WARNING - Log + continúa
  # Nivel 2: CAUTION - Reduce exposición 50%
  # Nivel 3: CRITICAL - Pausa trading + Alerta Telegram

  drawdown:
    warning_pct: 5.0
    caution_pct: 10.0
    critical_pct: 15.0
    action_on_critical: pause_all_trading

  daily_loss:
    warning_usd: 500
    caution_usd: 1000
    critical_usd: 2000
    action_on_critical: pause_until_next_day

  consecutive_losses:
    warning_count: 3
    caution_count: 5
    critical_count: 7
    action_on_critical: reduce_position_50pct

  model_disagreement:
    # Si los modelos no están de acuerdo
    warning_agreement_pct: 60  # Menos de 60% de acuerdo
    caution_agreement_pct: 50
    critical_agreement_pct: 40
    action_on_critical: skip_trade

  data_staleness:
    warning_seconds: 60
    caution_seconds: 300
    critical_seconds: 600
    action_on_critical: pause_trading

# =============================================================================
# ALERTAS - Solo críticas van a Telegram
# =============================================================================
alerts:
  telegram:
    enabled: true
    # Solo estos eventos van a Telegram:
    critical_events:
      - circuit_breaker_triggered
      - daily_loss_exceeded
      - system_error
      - model_reload_failed
      - broker_disconnection

    # Estos NO van a Telegram (solo log):
    silent_events:
      - trade_executed
      - model_validated
      - position_adjusted
      - warning_threshold

  # Resumen diario automático a las 22:00
  daily_summary:
    enabled: true
    time: "22:00"
    include:
      - total_pnl
      - trades_count
      - win_rate
      - active_positions
      - models_performance

# =============================================================================
# PRIORITIZATION - Orden automático de tareas
# =============================================================================
prioritization:
  # Orden de prioridad (1 = más alta)
  priority_order:
    1: security_risk     # Seguridad y gestión de riesgo SIEMPRE primero
    2: infrastructure    # Infraestructura y estabilidad del sistema
    3: features          # Nuevas funcionalidades y mejoras

  # Categorías de tareas
  categories:
    security_risk:
      description: "Circuit breakers, drawdown limits, position sizing, validación"
      examples:
        - "Fix drawdown calculation"
        - "Add stop loss"
        - "Circuit breaker triggered"
        - "Model validation failed"
      auto_escalate: true  # Siempre escala a nivel crítico si hay problemas

    infrastructure:
      description: "Data pipeline, broker connections, monitoring, backups"
      examples:
        - "Database connection failed"
        - "Broker disconnected"
        - "Data staleness detected"
        - "Grafana dashboard broken"
      auto_escalate: false

    features:
      description: "Nuevos modelos, estrategias, optimizaciones no críticas"
      examples:
        - "Train new agent"
        - "Add new symbol"
        - "Optimize hyperparameters"
        - "Improve reward function"
      auto_escalate: false

  # Reglas de interrución
  interrupt_rules:
    # Una tarea de mayor prioridad puede interrumpir una de menor
    allow_interruption: true
    # Guardar estado antes de interrumpir
    save_state_before_interrupt: true
    # Log de interrupciones
    log_interruptions: true

# =============================================================================
# AUTONOMOUS DECISIONS - Reglas para auto-gestión
# =============================================================================
autonomous_rules:
  # El sistema puede hacer esto SIN preguntar:
  allowed_actions:
    - adjust_position_size
    - pause_single_model
    - skip_low_confidence_trade
    - rebalance_exposure
    - archive_underperforming_model
    - switch_to_runpod_training

  # Esto REQUIERE alerta (pero no aprobación):
  notify_actions:
    - pause_all_trading
    - remove_model_from_voting
    - exceed_daily_budget

  # Esto NUNCA se hace automáticamente:
  forbidden_actions:
    - withdraw_funds
    - change_broker_credentials
    - delete_trained_models
    - modify_this_config

# =============================================================================
# MODELO DE VOTACIÓN
# =============================================================================
voting:
  min_models_required: 5  # Mínimo de modelos para operar
  min_agreement_pct: 60   # Mínimo acuerdo para señal válida

  aggregation_method: weighted_confidence
  # weighted_confidence: voto ponderado por Sharpe histórico
  # majority: voto simple de mayoría
  # unanimous: todos deben estar de acuerdo

  signal_cooldown_minutes: 60  # No repetir señal en mismo símbolo

  # Peso de cada modelo basado en performance reciente
  weight_lookback_days: 30
  weight_metric: sharpe_ratio

# =============================================================================
# SUPERVISIÓN (Lo que el usuario VE, no aprueba)
# =============================================================================
supervision:
  dashboard_refresh_seconds: 30

  metrics_to_display:
    - total_pnl_today
    - total_pnl_week
    - total_pnl_month
    - active_positions
    - voting_confidence
    - circuit_breaker_status
    - models_active_count

  grafana_dashboards:
    - trading_overview
    - model_performance
    - risk_metrics
    - system_health

# =============================================================================
# ML INSTITUCIONAL (EVAL-001 - D-025)
# Técnicas de nivel hedge fund basadas en López de Prado
# =============================================================================
ml_institutional:
  enabled: true
  evaluation_ref: "governance/evaluations/EVAL-001_institutional_ml.md"

  # R-005: Triple Barrier Labeling
  triple_barrier:
    enabled: true
    pt_mult: 2.0        # Take profit = 2x daily volatility
    sl_mult: 1.0        # Stop loss = 1x daily volatility
    min_ret: 0.005      # Minimum return threshold (filters noise)
    vertical_days: 10   # Maximum holding period
    vol_span: 100       # EWMA span for volatility

  # R-006: Purged K-Fold Cross-Validation
  purged_kfold:
    enabled: true
    n_splits: 5
    pct_embargo: 0.01   # 1% embargo gap

  # R-007: Sample Weighting
  sample_weights:
    enabled: true
    use_uniqueness: true
    use_time_decay: true
    decay_start: 0.5    # Oldest samples get 50% weight

  # R-008: Microstructure Features (D-028)
  microstructure_features:
    enabled: true       # IMPLEMENTED 2026-02-02
    features:
      - kyle_lambda     # Market impact
      - amihud          # Illiquidity ratio
      - roll_spread     # Implied spread
      - vpin            # Informed trading probability
      - corwin_schultz  # Spread estimator
      - flow_toxicity   # Order flow toxicity
      - volume_clock    # Volume-based time
      - price_efficiency # Variance ratio
    files:
      - "ml_institutional/microstructure_features.py"

  # R-008: Entropy Features (D-028)
  entropy_features:
    enabled: true       # IMPLEMENTED 2026-02-02
    features:
      - shannon_entropy
      - approximate_entropy
      - sample_entropy
      - lempel_ziv_complexity
    files:
      - "ml_institutional/entropy_features.py"

  # R-009: Meta-Labeling (D-034)
  meta_labeling:
    enabled: true       # IMPLEMENTED 2026-02-03
    min_primary_accuracy: 0.52
    combine_with_voting: true
    n_estimators: 100
    max_depth: 5
    cv_folds: 5
    min_bet_size: 0.1
    max_bet_size: 1.0
    files:
      - "ml_institutional/meta_labeling.py"

  # R-010: Kelly Criterion Bet Sizing (D-035)
  kelly_sizing:
    enabled: true       # IMPLEMENTED 2026-02-03
    kelly_fraction: 0.25  # Conservative: 1/4 Kelly
    min_prob_threshold: 0.52
    max_position_pct: 0.20
    min_position_pct: 0.01
    lookback_trades: 100
    use_time_decay: true
    vol_target: 0.15  # 15% target volatility
    files:
      - "ml_institutional/kelly_criterion.py"

  # Implementation status (Updated 2026-02-02)
  recommendations:
    R-005:
      name: "Triple Barrier Labeling"
      status: implemented
      priority: 1
      decision: "D-025"
      files:
        - "ml_institutional/triple_barrier.py"
    R-006:
      name: "Purged K-Fold CV"
      status: implemented
      priority: 2
      decision: "D-025"
      files:
        - "ml_institutional/purged_kfold.py"
    R-007:
      name: "Sample Weighting"
      status: implemented
      priority: 3
      decision: "D-025"
      files:
        - "ml_institutional/sample_weights.py"
    R-008:
      name: "Microstructure/Entropy Features"
      status: implemented
      priority: 4
      decision: "D-028"
      files:
        - "ml_institutional/microstructure_features.py"
        - "ml_institutional/entropy_features.py"
        - "gym_env/institutional_observation.py"
    R-009:
      name: "Meta-Labeling"
      status: implemented
      priority: 7
      decision: "D-034"
      files:
        - "ml_institutional/meta_labeling.py"
    R-010:
      name: "Kelly Criterion"
      status: implemented
      priority: 8
      decision: "D-035"
      files:
        - "ml_institutional/kelly_criterion.py"
    R-011:
      name: "Data Pipeline Robustness"
      status: implemented
      priority: 5
      decision: "D-032"
      files:
        - "data/validators/corporate_actions.py"
        - "data/validators/survivorship_bias.py"
        - "data/validators/point_in_time.py"
    R-012:
      name: "Risk Manager Real-Time"
      status: implemented
      priority: 6
      files:
        - "live/risk_manager.py"
    R-013:
      name: "Monitoring Completo"
      status: implemented
      priority: 7
      decision: "D-031"
      files:
        - "monitoring/health_checks.py"
        - "monitoring/metrics.py"
        - "monitoring/daily_reports.py"
        - "monitoring/model_drift.py"
    R-018:
      name: "Regime Detection"
      status: implemented
      priority: 8
      decision: "D-030"
      files:
        - "ml_institutional/regime_detector.py"
        - "ml_institutional/agent_selector.py"
    R-019:
      name: "Training por Regimen"
      status: implemented
      priority: 9
      decision: "D-033"
      files:
        - "training/regime_training.py"

  # Success criteria
  success_criteria:
    min_cv_accuracy: 0.52    # Must beat random
    target_cv_accuracy: 0.55  # Good performance
    min_sharpe: 1.0
    max_drawdown: 0.15
