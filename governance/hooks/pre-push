#!/bin/bash
# Pre-push hook for autonomous governance
#
# This hook runs BEFORE pushing to remote.
# It performs comprehensive validation:
# 1. Full integrity check of all protected files
# 2. Complete test suite execution
# 3. Validation pipeline for all changes since last push

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

echo "========================================"
echo "       PRE-PUSH GOVERNANCE CHECK        "
echo "========================================"

cd "$PROJECT_ROOT"

# ============================================
# CHECK 1: Full integrity verification
# ============================================
echo ""
echo "[1/3] Verifying system integrity..."

python -c "
import sys
sys.path.insert(0, '.')
from governance.integrity import verify_integrity

ok, violations = verify_integrity()
if not ok:
    print('[FAIL] Integrity violations detected:')
    for v in violations:
        print(f'  - {v}')
    sys.exit(1)
print('      [OK] All protected files verified')
"

INTEGRITY_RESULT=$?
if [ $INTEGRITY_RESULT -ne 0 ]; then
    echo ""
    echo "[BLOCKED] Cannot push with integrity violations"
    echo "Review and fix the issues above before pushing."
    exit 1
fi

# ============================================
# CHECK 2: Run test suite
# ============================================
echo "[2/3] Running test suite..."

# Check if pytest is available
if python -c "import pytest" 2>/dev/null; then
    # Run tests if they exist
    if [ -d "tests" ]; then
        TEST_FILES=$(find tests -name "test_*.py" 2>/dev/null | head -5)
        if [ -n "$TEST_FILES" ]; then
            echo "      Running pytest..."
            python -m pytest tests/ -v --tb=short -x 2>&1 | tail -20 || {
                echo ""
                echo "[WARNING] Some tests failed - continuing anyway"
                echo "(Tests are advisory for pre-push, not blocking)"
            }
        else
            echo "      [OK] No test files found - skipping"
        fi
    else
        echo "      [OK] No tests directory - skipping"
    fi
else
    echo "      [OK] pytest not installed - skipping tests"
fi

# ============================================
# CHECK 3: Validate all unpushed changes
# ============================================
echo "[3/3] Validating unpushed changes..."

# Get the remote and branch being pushed to
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        # Branch being deleted
        continue
    fi

    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # New branch, check all commits
        RANGE="$local_sha"
    else
        # Existing branch, check new commits
        RANGE="$remote_sha..$local_sha"
    fi

    # Get all changed files in the push
    CHANGED_FILES=$(git diff --name-only $RANGE 2>/dev/null || echo "")

    if [ -n "$CHANGED_FILES" ]; then
        echo "      Files in push:"
        echo "$CHANGED_FILES" | head -10 | while read f; do echo "        - $f"; done

        FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
        if [ "$FILE_COUNT" -gt 10 ]; then
            echo "        ... and $((FILE_COUNT - 10)) more files"
        fi

        # Run validation on changed files
        echo ""
        echo "      Running governance validation..."

        python -m governance.ci_cd --files $CHANGED_FILES --report 2>&1 | tail -30

        VALIDATE_RESULT=$?
        if [ $VALIDATE_RESULT -ne 0 ]; then
            echo ""
            echo "[BLOCKED] Governance validation failed"
            echo "Fix the issues above before pushing."
            exit 1
        fi
    fi
done

echo ""
echo "========================================"
echo "    [PASS] PRE-PUSH CHECKS PASSED       "
echo "========================================"
echo ""
echo "Push proceeding..."
exit 0
